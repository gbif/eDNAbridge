---
title: "eml_files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{eml_files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(eDNABridge)
```

# Creating EML files with eDNABridge

The `eDNABridge` package provides functions to create Ecological Metadata Language (EML) files for eDNA datasets. The underlying functions call the xml2 package and are designed to be used with pipes for ease of use. 

```{r}
# Example of creating an EML file
eml <- eml_base() |>
  eml_set_title("Sample eDNA Dataset") |>
  eml_set_abstract("This dataset contains eDNA samples collected from various locations.")

print(eml)
```

However, EML files can sometimes be fragile, and the order that you add elements to the EML file matters. This package provides high level functions to enter the appropriate details either into a function or from an external template (which can be generated by the package). Our recommendation is to use these functions, but expose the lower level functions for custom workflows. Consider using the emld::eml_validate() function to check that your EML file is valid, or other tools that can validate against XSD schemas.

Furthermore, GBIF has compulsory fields in the EML files that must be filled out. While you can successfully upload EML files missing these fields to other repositories, publishing the subsequently uploaded resource will fail. The high level functions in this package ensure that these compulsory fields are filled out.

```{r}
# This is normally calculated from a whole dataset
bbox_of_samples <- eml_calculate_bounding_box(
  lats= c(34.0, 35.0, 36.5), 
  longs= c(-120.0, -119.5, -121.0)
)

eml <- eml_gbif_create(
  title = "Dataset Title",
  creators = list(person("John", "Smith"), person("Jane", "Doe")), # Using base R `person()` function
  abstract = "Abstract of up to a paragraph describing data",
  license = "CC-BY-NC-4.0",
  coverage_geo_description = "Text description of geographic areas samples",
  coverage_bbox = bbox_of_samples, 
  coverage_start_date = "2022-01-01",
  coverage_end_date = "2022-02-13",
  maintenance_frequency = "monthly",
  maintenance_description = "Details about maintenance of dataset",
  contacts = list(person("John", "Smith", email="js@email.com"), person("Jane", "Doe")),
  step_description = "Data processing description",
  study_extent = "Description about where samples where taken from",
  sampling_description = "Sampling methods description",
  project_title = "Title of overarching project",
  project_personnel = list(person("John", "Smith"), person("Jane", "Doe"))
)

print(eml)
```

As these functions have a large number of arguments, the package additionally can generate and read a CSV template using the `eml_gbif_template_create` and `eml_gbif_template_read` functions which will feed the resulting information into the `eml_gbif_create` function, resulting in the same object.

A minimally valid EML file that is also compliant with the minimum compulsory fields of for upload to a GBIF IPT server should be assembled in the following order:

```r
# These low level functions can be customised or extended for more advanced use cases
eml_base() |>
  eml_set_title(...) |>
  eml_add_persons(type = "contact", ...) |> 
  eml_set_abstract(...) |>
  eml_set_license(...) |>
  eml_set_coverage(...) |>
  eml_set_maintenance(...) |>
  eml_add_persons(type = "contact", ...) |>
  eml_set_methods(...) |>
  eml_set_project(...) |>
  eml_add_project_personnel(...) |>
  eml_add_persons(...)
```

The resulting EML object can then including with `gen_make_dwc_archive()` to create a Darwin Core Archive for upload to GBIF or other repositories.